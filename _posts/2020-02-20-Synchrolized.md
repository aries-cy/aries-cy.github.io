---
title: synchronized和volatile
categories: [concurrent]
comments: true
---

##### synchronized关键字
synchronized 是 java 内置的同步锁实现，一个关键字实现对共享资源的锁定。synchronized 有 3 种使用场景，场景不同，加锁对象也不同：
* 普通的同步方法：锁是当前实例对象
* 静态同步方法：锁是当前class对象
* 同步方法块：锁是synchronized括号里的对象

###### synchronized原理
* 在java中，每一个对象都有一个monitor对象，当某一个线程占有这个对象时，判断monitor的计数器是不是0，如果是0，线程占有这个对象，并对monitor的计数器+1，如果不是0，即该对象被其他线程占有。
* 在 JDK6 之前，Monitor 的实现是依靠操作系统内部的互斥锁实现（一般使用的是 Mutex Lock 实现），线程阻塞会进行用户态和内核态的切换，所以同步操作是一个无差别的重量级锁。
* 后来，JDK 对 synchronized 进行升级，为了避免线程阻塞时在用户态与内核态之间切换线程，会在操作系统阻塞线程前，加入自旋操作。然后还实现 3 种不同的 Monitor：偏向锁（Biased Locking）、轻量级锁（Lightweight Locking）、重量级锁。

###### 锁升级
* synchronized 用的锁存在于 Java 对象头里，对象头里的 Mark Word 里存储的数据会随标志位的变化而变化
![对象头](https://aries-cy.github.io/assets/note_img/markdown.png)

* 无锁：初始状态，没有任何线程访问的同步代码块
* 偏向锁：
    * 判断对象的MarkWord中的线程id是否指向当前线程，如果是，执行同步代码块
    * 如果不是，查看MarkDown中的偏向锁标志位是不是1，如果不是，则表示无锁化状态，CAS将MarkDown中的线程ID指向当前线程，进入同步块
    * 如果是1，说明是偏向锁，并且出现了锁竞争，如果竞争失败，升级为轻量级锁
    * 偏向锁撤销：偏向锁总是偏向某个线程，若线程挂掉，置为无锁状态，若没有挂掉，且不使用该锁对象，在一个线程安全节点首先暂停偏向线程，偏向新的线程
* 轻量级锁：
    * 首先把同步对象的MarkWord复制一份到当前线程的栈帧空间，并用CAS将同步对象的MarkDown更新为指向该空间的指针，更改成功则获取锁，否则CAS自旋
    * 轻量级解锁时，会用CAS将栈帧中的MarkWord替换回对象头，如果替换成功，表示没有锁竞争，如果失败，表示当前锁存在竞争，锁就会膨胀成重量级锁
* 重量级锁：
    * 进入同步块必须获取monitor对象，获取失败则进入阻塞队列

##### volatile关键字
* volatile保证了不同线程对共享变量操作的可见性，即一个线程修改了volatile修饰的变量，当修改写回主内存时，另一个线程立即看到最新的值。

当多个处理器的运算任务都涉及同一块内存区域时，可能导致各自内存缓存的数据不一样，那么同步回主内存时，以谁的缓存数据为准呢？
* 为了解决一致性问题，各个处理器访问缓存时，都需要遵循一些协议，比如MSI、MESI、MOSI、FIleFly等
* MESI(缓存一致性协议)：当CPU写数据时，如果发现操作的变量是共享变量，即在其他CPU中也存在该变量的副本，会发出信号通知其他CPU将该变量的缓存行置为无效状态，因此当其他CPU需要读取这个变量时，发现自己缓存中缓存该变量的缓存行是无效的，那么它就会从内存重新读取。

处理器怎么发现数据是否失效呢？
* 嗅探：每个处理器通过嗅探在总线上传播的数据来检查自己缓存的值是不是过期了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置成无效状态，当处理器对这个数据进行修改操作的时候，会重新从系统内存中把数据读到处理器缓存里。
* 由于Volatile的MESI缓存一致性协议，需要不断的从主内存嗅探和cas不断循环，无效交互会导致总线带宽达到峰值，所以不要大量使用Volatile。

###### 禁止指令重排序
为了提高性能，编译器和处理器常常会对既定的代码执行顺序进行指令重排序。

* as-if-serial
    * 不管怎么重排序，单线程下的执行结果不能被改变。
* happens-before
    * 如果一个操作执行的结果需要对另一个操作可见，那么这两个操作之间必须存在happens-before关系。
    * 如果现在我的变了falg变成了false，那么后面的那个操作，一定要知道我变了。
